<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>SQL Injection Detector</title>
        <link rel="stylesheet" href="./assets/style.css" />
        <link rel="icon" type="image/svg+xml" href="assets/zen.svg" />
    </head>
    <body>
        <a class="back" href="./">← Back</a>
        <h1>SQL Injection Detector</h1>

        <label for="query">SQL Query (with user input embedded)</label>
        <textarea id="query">SELECT * FROM users WHERE name = 'admin'--' AND active = 1</textarea>

        <div class="row">
            <div>
                <label for="userinput">User Input</label>
                <input
                    id="userinput"
                    type="text"
                    value="admin'--"
                />
            </div>
            <div>
                <label for="dialect">Dialect</label>
                <select id="dialect">
                    <option value="0" selected>Generic</option>
                    <option value="1">ANSI</option>
                    <option value="2">BigQuery</option>
                    <option value="3">ClickHouse</option>
                    <option value="4">Databricks</option>
                    <option value="5">DuckDB</option>
                    <option value="6">Hive</option>
                    <option value="7">MSSQL</option>
                    <option value="8">MySQL</option>
                    <option value="9">PostgreSQL</option>
                    <option value="10">Redshift</option>
                    <option value="11">Snowflake</option>
                    <option value="12">SQLite</option>
                </select>
            </div>
        </div>

        <label>Result</label>
        <div id="output" class="result"></div>

        <script type="module">
            import init, {
                wasm_detect_sql_injection,
            } from "./pkg/zen_internals.js";

            const queryEl = document.getElementById("query");
            const userinputEl = document.getElementById("userinput");
            const dialectEl = document.getElementById("dialect");
            const outputEl = document.getElementById("output");

            function run() {
                try {
                    const result = wasm_detect_sql_injection(
                        queryEl.value,
                        userinputEl.value,
                        parseInt(dialectEl.value, 10),
                    );

                    outputEl.className = "result";
                    if (result === 1) {
                        outputEl.classList.add("detected");
                        outputEl.textContent = "⚠ Injection detected";
                    } else if (result === 3) {
                        outputEl.classList.add("warning");
                        outputEl.textContent = "Could not tokenize query";
                    } else {
                        outputEl.classList.add("safe");
                        outputEl.textContent = "✓ No injection detected";
                    }
                } catch (e) {
                    outputEl.className = "result warning";
                    outputEl.textContent = String(e);
                }
            }

            queryEl.addEventListener("input", run);
            userinputEl.addEventListener("input", run);
            dialectEl.addEventListener("change", run);

            await init();
            run();
        </script>
    </body>
</html>
